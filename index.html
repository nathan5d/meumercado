<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Listas de Compras</title>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">

    <!-- Dentro da seção head -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="manifest" href="./manifest.json">

    <!-- Torna o aplicativo web executável em tela cheia no iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Define a cor da barra de status no Android -->
    <meta name="theme-color" content="#ffffff">

    <!-- Define a cor da barra de status no iOS -->
    <meta name="apple-mobile-web-app-status-bar" content="#ffffff" />
    <!-- Define o estilo da barra de status no iOS como "black-translucent" para um visual translúcido -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Título exibido quando o aplicativo é adicionado à tela inicial no iOS -->
    <meta name="apple-mobile-web-app-title" content="Meu Mercado">

    <!-- Ícone do aplicativo na tela inicial do iOS -->
    <link rel="apple-touch-icon" href="/assets/images/AppIcon.png">



    <link rel="stylesheet" href="./vendor/bulma/css/bulma.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">

    <script src="./vendor/jquery/dist/jquery.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" type="text/css" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />


    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>

<body class="">
    <!-- Container principal -->
    <div class="container">


        <!-- Conteúdo do aplicativo -->
        <section class="full-content home">
            <i class="ph-bold ph-smiley"></i>
            <i class="ph-bold ph-heart" style="color: hotpink"></i>
            <i class="ph-bold ph-cube"></i>
            <nav class="navbar" role="navigation" aria-label="main navigation">

                <div class="navbar-menu">
                    <!-- shown on mobile -->
                    <div class="navbar-item">

                        <label class="title">Minhas listas</label>

                    </div>

                    <div class="navbar-item">
                        <span class="icon is-large">
                            <button class="button icon right" onclick="toggleDarkMode()">

                                <ion-icon name="moon" class="darkModeToggle"></ion-icon>
                            </button>
                        </span>

                    </div>

                </div>

            </nav>



            <!-- Lista de listas com estilo iOS -->
            <div class="box-content-header">
                <span class="box-content-title">Listas de Compras</span>
            </div>
            <div class="box-content">
                <ul id="listas" class="menu-list">
                    <!-- Listas de compras serão adicionadas aqui -->
                </ul>
                <!-- Botão para limpar a lista com estilo iOS -->

            </div>

            <div class="box-content-header">
                <span class="box-content-title">Nova Lista</span>
            </div>
            <div class="box-content new-list">
                <!-- Campos e botões com estilo iOS -->
                <div class="field">
                    <label class="label">Nome da Lista</label>
                    <div class="control">
                        <input class="input" type="text" id="nomeLista" placeholder="Nome da Lista">
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" onclick="criarLista()">Criar Lista</button>
                    </div>
                </div>
            </div>





        </section>
        <!-- Container para campos de adicionar item (inicialmente oculto) -->
        <div id="camposAdicionarItem" class="full-content list" style="display: none;">
            <nav class="navbar" role="navigation" aria-label="main navigation">

                <div class="navbar-menu">
                    <!-- shown on mobile -->
                    <div class="navbar-item">
                        <span class="icon toback is-large">
                            <button class="button icon left" id="toback" onclick="ocultarLista()">
                                <ion-icon name="ios-arrow-back"></ion-icon>
                            </button>
                        </span>
                        <label class="subtitle nome-lista-atual" for="toback">Voltar</label>
                    </div>

                    <div class="navbar-item">
                        <div class="navbar-item">
                            <span class="icon is-large">
                                <button class="button icon" onclick="toggleDarkMode()">
                                    <span class="icon">
                                        <ion-icon name="moon" class="darkModeToggle"></ion-icon>
                                    </span>
                                </button>
                            </span>

                        </div>
                        <!-- Dropdown para opções de importação e exportação -->
                        <div class="navbar-item">
                            <!-- Dropdown para opções de importação e exportação -->
                            <div class="dropdown is-right" id="dropdown-options">
                                <div class="dropdown-trigger">
                                    <button class="button icon" id="dropdownButton" aria-hidden="true"
                                        aria-haspopup="true" aria-controls="dropdown-menu">
                                        <span class="icon">
                                            <ion-icon name="ios-menu"></ion-icon>
                                        </span>
                                    </button>
                                </div>
                                <div class="dropdown-menu" id="dropdown-menu" role="menu">
                                    <div class="dropdown-content">
                                        <div class="dropdown-item">
                                            <div class="file is-normal is-fullwidth">
                                                <label class="file-label">
                                                    <input class="file-input" id="fileInput" type="file" name="resume">
                                                    <span class="file-cta" style="width: 100%;">
                                                        <span class="file-label">
                                                            <span class="icon">
                                                                <ion-icon name="ios-cloud-upload"></ion-icon>
                                                            </span>
                                                            <span> Importar</span>
                                                        </span>
                                                    </span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="dropdown-item">
                                            <button class="button header" id="botaoExportar">
                                                <span class="icon">
                                                    <ion-icon name="ios-cloud-download"></ion-icon>
                                                </span>
                                                <span>
                                                    Exportar
                                                </span>
                                            </button>
                                        </div>

                                        <div class="dropdown-item">
                                            <button class="button is-danger" onclick="removerListaAtual()">
                                                <span class="icon">
                                                    <ion-icon name="ios-close"></ion-icon>
                                                </span>
                                                <span>
                                                    Remover Lista
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </nav>


            <!-- Lista de itens com estilo iOS -->


            <div class="box-content-header">
                <span class="box-content-title" id="nomeListaAtual">Itens da Lista</span>
            </div>
            <div class="box-content list">
                <ul id="lista">
                    <!-- Itens da lista serão adicionados aqui -->
                </ul>
            </div>

            <div class="box-content">
                <div class="total">
                    <div id="totaLista">Total: <b id="totalLista"></b></div>
                    <div class="foraCarrinho">Não marcados: <b id="totalForaCarrinho"></b></div>
                    <div class="carrinho">Marcados: <b id="totalCarrinho"></b></div>
                </div>

            </div>

            <div class="box-content">
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-danger" onclick="limparLista()">Limpar Lista</button>
                    </div>
                </div>
            </div>


        </div>
        <!-- Modal de Edição/Adição de Item -->
        <button class="btn-add show">
            <icon>+</icon>
        </button>
        <div class="box-content-modal" style="text-align: center;">
            <div class="close">
                <icon>&times;</icon>
            </div>
            <div class="x-panel-mobile"></div>
            <p class="subtitle is-5 nome-lista-atual" id="nomeListaAtualModal"></p>
            <div class="content">
                <!-- Campos e botões com estilo iOS para editar/adicionar itens -->
                <div class="field">
                    <label class="label">Nome do Item</label>
                    <div class="control">
                        <input class="input" type="text" id="editItem" placeholder="Nome do Item">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Quantidade</label>
                    <div class="control">
                        <input class="input" type="number" id="editQuantidade" placeholder="Quantidade">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Preço</label>
                    <div class="control">
                        <input class="input" type="number" id="editPreco" placeholder="Preço">
                    </div>
                </div>
                <div class="field">
                    <label class="label">Unidade</label>
                    <div class="control">
                        <input class="input" type="text" id="editUnidade" placeholder="Unidade">
                    </div>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-primary" id="editarItemBtn" onclick="editarItem()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="offline-message" class="offline-message">
            Você está offline. O conteúdo pode não estar atualizado.
        </div>

    </div>
    <div id="loading-overlay">
        <div id="loading-spinner">
            <!-- Coloque aqui o ícone ou animação de carregamento -->
            <ion-icon name="refresh"></ion-icon>
        </div>
    </div>


    <script>
        // Função para mostrar/ocultar campos de adicionar item
        function mostrarCamposAdicionarItem() {
            const camposAdicionarItem = $("#camposAdicionarItem");
            camposAdicionarItem.toggle();
        }

        // Função para criar uma nova lista de compras
        function criarLista() {
            const nomeListaInput = $("#nomeLista");
            const nomeLista = nomeListaInput.val().trim();

            if (nomeLista !== "") {
                const lista = { items: [] }; // Crie uma nova lista vazia
                const listas = JSON.parse(localStorage.getItem("listas")) || [];

                if (!listas.includes(nomeLista)) {
                    listas.push(nomeLista);
                    localStorage.setItem("listas", JSON.stringify(listas));
                }

                localStorage.setItem(nomeLista, JSON.stringify(lista));
                nomeListaInput.val("");

                listarListas();
                mostrarLista(nomeLista);
            }
        }

        // Função para listar todas as listas disponíveis
        // Função para listar todas as listas disponíveis
        // Função para listar todas as listas disponíveis
        function listarListas() {
            // Obtém as listas do Local Storage ou cria uma lista vazia se não existir
            const listas = JSON.parse(localStorage.getItem("listas")) || [];

            // Seleciona o elemento <ul> com o ID "listas"
            const listasUl = $("#listas");

            // Limpa o conteúdo atual da lista antes de atualizá-lo
            listasUl.html("");

            // Itera sobre cada lista e cria um item de lista (<li>) para cada uma
            $.each(listas, function (index, lista) {
                const listItem = $("<li>");

                const listContainer = $("<div>").addClass("list-container");

                const listNome = $("<span>").addClass('').text(lista);

                listContainer.append(listNome);

                // Adiciona um evento de clique ao item da lista para mostrar a lista
                listItem.click(function () {
                    mostrarLista(lista);
                });

                // Obtém a lista de itens para a lista atual
                let listaItens = JSON.parse(localStorage.getItem(lista));

                // Verifica se listaItens.items é um array; se não, cria um array vazio
                if (!Array.isArray(listaItens.items)) {
                    listaItens.items = [];
                }

                // Calcula a contagem de itens marcados e o total de itens
                const itensMarcados = listaItens.items.filter(item => item.selecionado).length;
                const totalItens = listaItens.items.length;

                // Calcula a porcentagem de itens marcados em relação ao total
                const porcentagem = (itensMarcados / totalItens) * 100;

                // Cria a barra de progresso
                const progressContainer = $("<div>").addClass("progress-container");
                const progress = $("<div>").addClass("completebar")

                setTimeout(function () {
                    // Altere a largura da barra de progresso para 100% após o atraso
                    progress.css("width", porcentagem + "%");
                }, 200);


                progressContainer.append(progress);

                // Adiciona a contagem de itens e a barra de progresso ao item da lista
                const contagem = $('<span>').text(`${itensMarcados}/${totalItens}`);
                listContainer.append(contagem);
                listContainer.append(progressContainer);

                listItem.append(listContainer);

                // Adiciona o item da lista à lista não ordenada (<ul>)
                listasUl.append(listItem);
            });
        }

        // Chama a função inicialmente para listar as listas disponíveis
        //listarListas();



        function ocultarLista() {
            buttonAdd.hide();
            const camposAdicionarItem = $("#camposAdicionarItem");
            camposAdicionarItem.hide();
            listarListas();
            //mostr
            //reloadPage();
        }

        const buttonAdd = {
            show: () => {
                $(".btn-add").addClass("show").removeClass("hidden");
            },
            hide: () => {
                $(".btn-add").addClass("hidden").removeClass("show");
            }
        };



        function enableSwipeToEdit2() {
            console.log('habilitado')
            // Seletor para os elementos que terão a funcionalidade de swipe
            const swipeElements = $('.c-control');

            // Loop pelos elementos e adicionando a funcionalidade de swipe
            swipeElements.each(function () {
                const $element = $(this);
                const hammer = new Hammer(this);

                hammer.on('swipe', function (event) {
                    if (event.deltaX > 0) {
                        console.log('direita')
                        //alert('direita');
                        // Deslizar para a direita (ação a ser executada)
                        $element.removeClass('swipe-edit');
                    } else {
                        //alert('esquerda');
                        // Deslizar para a esquerda (ação a ser executada)
                        $element.addClass('swipe-edit');
                    }
                });
            });
        }

        function enableSwipeToEdit3() {
            console.log('habilitado');
            // Seletor para os elementos que terão a funcionalidade de swipe
            const swipeElements = $('.c-control');

            // Loop pelos elementos e adicionando a funcionalidade de swipe
            swipeElements.each(function () {
                const $element = $(this);
                let startX; // Para rastrear a posição inicial

                // Use o Draggable do jQuery UI
                $element.draggable({
                    axis: 'x', // Somente permita o movimento horizontal
                    start: function (event, ui) {
                        startX = ui.position.left;
                    },
                    drag: function (event, ui) {
                        const deltaX = ui.position.left - startX;

                        // Defina uma distância mínima para ativar a ação de swipe (ajuste conforme necessário)
                        const threshold = 50;

                        if (deltaX > threshold) {
                            // Deslizar para a direita (ação a ser executada)
                            $element.removeClass('swipe-edit');
                        } else if (deltaX < -threshold) {
                            // Deslizar para a esquerda (ação a ser executada)
                            $element.addClass('swipe-edit');
                        }
                    },
                    stop: function () {
                        // Limpe a posição inicial
                        startX = 0;
                    },
                });
            });
        }

        function enableSwipeToEdit4() {
            console.log('habilitado');
            // Seletor para os elementos que terão a funcionalidade de swipe
            const swipeElements = $('.c-control');

            // Loop pelos elementos e adicionando a funcionalidade de swipe
            swipeElements.each(function () {
                const $element = $(this);
                let isSwiped = false;

                // Use o Draggable do jQuery UI
                $element.draggable({
                    axis: 'x', // Somente permita o movimento horizontal
                    containment: [-100, 0, 10, 0], // Defina os limites de movimento horizontal
                    start: function () {
                        isSwiped = false;
                    },
                    drag: function (event, ui) {
                        console.log(ui.position.left)
                        if (ui.position.left < -10 && !isSwiped) {
                            // Se o elemento foi arrastado para a esquerda o suficiente, exiba as opções
                            isSwiped = true;
                            $element.addClass('swipe-edit');
                        } else if (ui.position.left > -100 && isSwiped) {
                            // Se o elemento foi arrastado de volta para a direita, oculte as opções
                            isSwiped = false;
                            $element.removeClass('swipe-edit');
                            ui.position.left = 10;
                        }
                    },
                    stop: function () {
                        // Redefina a posição após o término do arrasto
                        //$element.css('left', 0);
                    },
                });
            });
        }

        function enableSwipeToEdit5() {
            console.log('habilitado');
            // Seletor para os elementos que terão a funcionalidade de swipe
            const swipeElements = $('.c-control');

            // Loop pelos elementos e adicionando a funcionalidade de swipe
            swipeElements.each(function () {
                const $element = $(this).find('.item-content');
                const $showOptions = $element.find('.item-options');
                let isSwiping = false;
                let originalX = 0;

                // Use o Hammer.js para reconhecimento de gestos
                const hammer = new Hammer(this);

                hammer.on('panstart', function (event) {
                    isSwiping = true;
                    originalX = $element.position().left;
                });

                //const $element =  $element.closest('li');
                hammer.on('panmove', function (event) {
                    if (isSwiping) {
                        const deltaX = originalX + event.deltaX;

                        if (deltaX <= 0) {
                            $element.css('transform', `translateX(${deltaX}px)`);

                        }
                        console.log(deltaX);
                        // Adicione um limiar para exibir as opções de edição e exclusão
                        /* if (deltaX < -50 && deltaX >= -100) {
                             // Exibir opção de editar
                             $element.closest('li').addClass('show-edit-option');
                             $element.closest('li').removeClass('show-delete-option');
                         } else if (deltaX < -100) {
                             // Exibir opção de excluir
                             $element.closest('li').addClass('show-delete-option');
                             //$element.removeClass('show-edit-option');
                         } else {
                             // A posição do elemento não atingiu nenhum limiar
                             $element.closest('li').removeClass('show-edit-option');
                             $element.closest('li').removeClass('show-delete-option');
                         }*/
                    }
                });

                hammer.on('panend', function (event) {
                    if (isSwiping) {
                        isSwiping = false;
                        originalX = 0;
                        const deltaX = event.deltaX;

                        if (deltaX > 0) {
                            // Deslizar para a direita (ação a ser executada)
                            $element.closest('li').removeClass('swipe-edit');
                            $element.css('transform', 'translateX(0)');
                        } else {
                            if (deltaX < -0 && deltaX >= -50) {
                                console.log('entrou no if do panned < -50 >= -100', deltaX)
                                // Exibir opção de editar
                                $element.closest('li').addClass('swipe-edit');
                                $element.css('transform', 'translateX(-40px)');
                                //$showOptions.css('transform', 'translateX(90px)');
                            } else if (deltaX <= -50) {
                                // Exibir opção de excluir
                                console.log('entrou no else do panned < -100', deltaX)
                                // Exibir opção de editar
                                $element.closest('li').addClass('swipe-edit');
                                $element.closest('li').addClass('swipe-delete');
                                $element.css('transform', 'translateX(-80px)');
                                //$showOptions.css('transform', 'translateX(180px)');
                            } else {
                                console.log('entrou no else do panned', deltaX)
                                $element.closest('li').removeClass('swipe-delete');
                                $element.closest('li').addClass('swipe-edit');
                                $element.css('transform', 'translateX(-40px)');
                                //$showOptions.css('transform', 'translateX(90px)');
                            }
                        }
                    }
                });
            });
        }

        function enableSwipeToEdit() {
            console.log('habilitado');
            // Seletor para os elementos que terão a funcionalidade de swipe
            const swipeElements = $('.c-control');

            // Loop pelos elementos e adicionando a funcionalidade de swipe
            swipeElements.each(function () {
                const $element = $(this).find('.item-content');
                const $showOptions = $element.find('.item-options');
                let isSwiping = false;
                let originalX = 0;
                let lastDeltaX = 0;

                // Use o Hammer.js para reconhecimento de gestos
                const hammer = new Hammer(this);

                hammer.on('panstart', function (event) {
                    isSwiping = true;
                    originalX = $element.position().left;
                });

                //const $element =  $element.closest('li');
                hammer.on('panmove', function (event) {
                    if (isSwiping) {
                        const deltaX = originalX + event.deltaX;

                        if (deltaX <= 0) {
                            lastDeltaX = deltaX;
                            $element.css('transform', `translateX(${deltaX}px)`);
                        }
                        console.log(deltaX);
                        // Adicione um limiar para exibir as opções de edição e exclusão
                       /* if (lastDeltaX < -0 && lastDeltaX >= -50) {
                            // Exibir opção de editar
                            $element.closest('li').addClass('swipe-edit');
                            // $element.css('transform', 'translateX(-40px)');
                            //$showOptions.css('transform', 'translateX(90px)');
                        } else if (lastDeltaX < -50) {
                            // Exibir opção de excluir
                            $element.closest('li').addClass('swipe-edit swipe-delete');
                            //$element.css('transform', 'translateX(-80px)');
                            //$showOptions.css('transform', 'translateX(180px)');
                        } else {
                            // A posição do elemento não atingiu nenhum limiar
                            $element.closest('li').removeClass('swipe-edit swipe-delete');
                        }*/
                    }
                });

                hammer.on('panend', function (event) {
                    if (isSwiping) {
                        isSwiping = false;
                        originalX = 0;
                        const deltaX = event.deltaX;

                        if (deltaX > 0) {
                            // Deslizar para a direita (ação a ser executada)
                            $element.closest('li').removeClass('swipe-edit swipe-delete');
                            $element.css('transform', 'translateX(0)');
                        } else if (lastDeltaX < -0 && lastDeltaX >= -50) {
                            // Permanece na posição de edição
                            $element.closest('li').addClass('swipe-edit');
                            $element.css('transform', 'translateX(-40px)');
                        } else if (lastDeltaX < -50) {
                            // Permanece na posição de exclusão
                            
                            $element.closest('li').addClass('swipe-edit swipe-delete');
                            $element.css('transform', 'translateX(-80px)');
                        }
                    }
                });
            });
        }

        // Chame a função para habilitar o swipe
        //enableSwipeToEdit();

        // Chame a função para habilitar o swipe
        //enableSwipeToEdit();


        // Chame a função para habilitar o swipe
        //enableSwipeToEdit();

        // Chame a função para habilitar o swipe
        //enableSwipeToEdit();


        // Função para mostrar uma lista específica
        function mostrarLista(nomeLista) {
            buttonAdd.show();
            //$(".btn-add").addClass("show").removeClass("hidden");
            const nomeListaAtual = $("#nomeListaAtual");
            nomeListaAtual.text(nomeLista);

            // Mostrar campos de adicionar item quando uma lista é selecionada
            const camposAdicionarItem = $("#camposAdicionarItem");

            camposAdicionarItem.show();

            let lista = JSON.parse(localStorage.getItem(nomeLista)) || { items: [] }; // Obtenha a lista do LocalStorage

            console.log
            const listaUl = $("#lista");
            listaUl.html("");

            let totalLista = 0; // Inicialize o total da lista
            let totalCarrinho = 0; // Inicialize o total do carrinho
            let totalForaDoCarrinho = 0;

            $.each(lista.items, function (index, item) {
                const controlContainer = $("<div>");
                const checkboxContainer = $("<div>").addClass('item-content');
                const checkboxLabel = $("<label>").text(item.nome);//.attr({ for: "item" + index });
                const checkbox = $("<input>").attr({
                    type: "checkbox",
                    class: "item-checkbox",
                    id: "item" + index,
                    "data-index": index
                });


                // Adicione um identificador aos itens selecionados
                checkbox.attr("data-selecionado", item.selecionado);

                const checkmark = $("<span>").addClass("checkmark");
                checkboxLabel.append(checkbox, checkmark);
                //checkboxContainer.append(checkboxLabel);

                // Formatando os valores como monetários (Reais - BRL)
                const precoFormatado = item.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const totalItem = (item.quantidade * item.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                checkboxContainer.append(checkboxLabel, `${item.quantidade} x, ${precoFormatado} ${item.unidade}, ${totalItem}`);
                //const listItem = $("<li>").append(checkboxContainer, `${item.quantidade} x, Preço: ${precoFormatado} ${item.unidade}, Total: ${totalItem}`);
                controlContainer.append(checkboxContainer);
                const listItem = $("<li>").append(controlContainer).addClass("c-control");

                const actionsContainer = $('<div>').addClass('item-options');

                listaUl.append(listItem);

                //button editar
                const editButton = $("<button>").html('<ion-icon name="ios-create"></ion-icon>');
                editButton.click(function () {
                    iniciarEdicaoOuAdicao(index);
                });



                //button excluir
                const deleteButton = $("<button>").addClass('is-danger').html('<ion-icon name="ios-trash"></ion-icon>');
                deleteButton.click(function () {
                    const confirmDelete = confirm("Tem certeza de que deseja excluir este item?");

                    if (confirmDelete) {
                        // O usuário confirmou a exclusão
                        excluirItem(nomeLista, index);
                    }

                   // excluirItem(nomeLista, index); // Chame a função para excluir o item
                });

                actionsContainer.append(deleteButton);
                // listItem.append(editButton);
                actionsContainer.append(editButton);

                listItem.append(actionsContainer);

                // Adicionar eventos para marcar/desmarcar os itens
                checkbox.change(function () {
                    const isChecked = this.checked;
                    const dataIndex = $(this).data("index");

                    // Marcar/desmarcar o item no array de itens
                    lista.items[dataIndex].selecionado = isChecked;

                    // Atualizar o LocalStorage
                    localStorage.setItem(nomeLista, JSON.stringify(lista));
                    console.log(nomeLista, JSON.stringify(lista));

                    // Atualizar o total do carrinho e fora do carrinho
                    atualizaTotais(lista); // Passe a lista como argumento
                });

                // Calculando o total da lista
                totalLista += item.quantidade * item.preco;

                // Verificando se o item já está selecionado e marcando a caixa de seleção, se necessário
                if (item.selecionado) {
                    checkbox.prop("checked", true);
                    totalCarrinho += item.quantidade * item.preco;
                }
            });

            // Exibir os totais no final
            const totalListaFormatado = totalLista.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalCarrinhoFormatado = totalCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalForaCarrinhoFormatado = totalForaDoCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            $("#totalLista").text(totalListaFormatado);

            // Função para atualizar os totais
            function atualizaTotais(lista) { // Receba a lista como argumento
                // Recalcule os totais do carrinho e fora do carrinho
                totalCarrinho = 0;
                totalForaDoCarrinho = 0;
                $.each(lista.items, function (index, item) {
                    const totalItem = item.quantidade * item.preco;
                    if (item.selecionado) {
                        totalCarrinho += totalItem;
                    } else {
                        totalForaDoCarrinho += totalItem;
                    }
                });

                // Atualize os totais na página
                const totalCarrinhoFormatado = totalCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const totalForaCarrinhoFormatado = totalForaDoCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                $("#totalCarrinho").text(totalCarrinhoFormatado);
                $("#totalForaCarrinho").text(totalForaCarrinhoFormatado);

                // Atualize o LocalStorage com a lista atualizada
                localStorage.setItem(nomeLista, JSON.stringify(lista));


            }

            // Chame a função para atualizar os totais
            atualizaTotais(lista); // Passe a lista como argumento
            enableSwipeToEdit();
        }

        // Função para iniciar a edição ou adição de um item
        function iniciarEdicaoOuAdicao(indice) {
            const nomeListaAtual = $("#nomeListaAtual").text();
            const lista = JSON.parse(localStorage.getItem(nomeListaAtual)) || { items: [] };

            if (indice >= 0) { // Se o índice for fornecido, estamos editando um item existente
                // Preencha os campos de edição com os valores do item selecionado
                const itemEditado = lista.items[indice];
                $("#editItem").val(itemEditado.nome);
                $("#editQuantidade").val(itemEditado.quantidade);
                $("#editPreco").val(itemEditado.preco);
                $("#editUnidade").val(itemEditado.unidade);

                // Defina o índice do item sendo editado como um atributo de dados no botão "Salvar"
                $("#nomeListaAtualModal").text("Editando: " + itemEditado.nome);
                $("#editarItemBtn").data("indice", indice);
            } else { // Caso contrário, estamos adicionando um novo item
                // Limpe os campos de edição
                $("#editItem").val("");
                $("#editQuantidade").val("1");
                $("#editPreco").val("0");
                $("#editUnidade").val("Un");

                // Limpe o atributo de dados do botão "Salvar"
                $("#editarItemBtn").removeData("indice");

                // Defina o texto apropriado no modal
                $("#nomeListaAtualModal").text("Adicionar Novo Item");
            }

            // Abra o modal de edição/adicão
            //$(".box-content-modal").addClass("active");
            abrirModal();
        }
        // Função para editar um item
        // Função para editar ou adicionar um item
        function editarItem() {
            const nomeListaAtual = $("#nomeListaAtual").text();
            const editItemInput = $("#editItem");
            const editQuantidadeInput = $("#editQuantidade");
            const editPrecoInput = $("#editPreco");
            const editUnidadeInput = $("#editUnidade");

            const nomeItemEditado = editItemInput.val().trim();
            const quantidadeEditada = parseFloat(editQuantidadeInput.val());
            const precoEditado = parseFloat(editPrecoInput.val());
            const unidadeEditada = editUnidadeInput.val().trim();

            // Obtenha o índice do item sendo editado (se existir)
            const indiceDoItemEditado = $("#editarItemBtn").data("indice");

            // Obtenha a lista do LocalStorage
            const lista = JSON.parse(localStorage.getItem(nomeListaAtual)) || { items: [] };

            if (indiceDoItemEditado !== undefined && indiceDoItemEditado >= 0) { // Se estamos editando um item existente
                // Atualize os valores do item com os valores dos campos de edição
                lista.items[indiceDoItemEditado].nome = nomeItemEditado;
                lista.items[indiceDoItemEditado].quantidade = quantidadeEditada;
                lista.items[indiceDoItemEditado].preco = precoEditado;
                lista.items[indiceDoItemEditado].unidade = unidadeEditada;
            } else { // Caso contrário, estamos adicionando um novo item
                const item = {
                    nome: nomeItemEditado,
                    quantidade: quantidadeEditada,
                    preco: precoEditado,
                    unidade: unidadeEditada,
                    selecionado: false
                };
                lista.items.push(item);
            }

            // Atualize o LocalStorage com a lista atualizada
            localStorage.setItem(nomeListaAtual, JSON.stringify(lista));

            // Recarregue a lista e exiba-a novamente
            atualizarLista();

            // Feche o modal de edição/adicão
            $("#nomeListaAtualModal").text(""); // Limpe o texto do modal
            //$(".box-content-modal").removeClass("active"); // Feche o modal
            fecharModal();
            // Após adicionar conteúdo, chame a função para ajustar a posição do modal
            ajustarPosicaoModal();
        }

        // Função para excluir um item da lista
        function excluirItem(nomeLista, index) {
            // Obtenha a lista atual do Local Storage
            const listaAtual = JSON.parse(localStorage.getItem(nomeLista));

            // Verifique se a lista existe
            if (listaAtual && Array.isArray(listaAtual.items)) {
                // Remova o item pelo índice
                listaAtual.items.splice(index, 1);

                // Salve a lista atualizada no Local Storage
                localStorage.setItem(nomeLista, JSON.stringify(listaAtual));

                // Atualize a interface do usuário ou realize outras ações necessárias
                console.log('Item excluído com sucesso.');

                // Atualize a lista de itens na interface do usuário
                mostrarLista(nomeLista);
            }
        }


        // Função para remover a lista atual
        function removerListaAtual() {
            const nomeListaAtual = $("#nomeListaAtual").text();
            if (confirm(`Tem certeza de que deseja remover a lista "${nomeListaAtual}"?`)) {
                // Remover a lista do LocalStorage
                const listas = JSON.parse(localStorage.getItem("listas")) || [];
                const index = listas.indexOf(nomeListaAtual);
                if (index > -1) {
                    listas.splice(index, 1);
                    localStorage.setItem("listas", JSON.stringify(listas));
                }

                // Remover a lista atual do LocalStorage
                localStorage.removeItem(nomeListaAtual);

                // Limpar a lista na página
                atualizarLista();

                // Limpar o nome da lista atual
                $("#nomeListaAtual").text("");


                reloadPage();
            }
        }

        // Função para limpar a lista atual
        function limparLista() {
            const nomeListaAtual = $("#nomeListaAtual").text();
            if (confirm(`Tem certeza de que deseja limpar a lista "${nomeListaAtual}"?`)) {
                const lista = { items: [] };
                localStorage.setItem(nomeListaAtual, JSON.stringify(lista));
                atualizarLista();
            }
        }

        // Função para atualizar a lista na página
        // Função para atualizar a lista na página
        function atualizarLista() {
            const nomeListaAtual = $("#nomeListaAtual");
            const lista = JSON.parse(localStorage.getItem(nomeListaAtual.text())) || { items: [] };
            const listaUl = $("#lista");
            listaUl.html("");

            let totalLista = 0;
            let totalCarrinho = 0;
            let totalForaDoCarrinho = 0;

            $.each(lista.items, function (index, item) {
                const controlContainer = $("<div>");
                const checkboxContainer = $("<div>").addClass('item-content');
                const checkboxLabel = $("<label>").addClass("").text(item.nome);//.attr({ for: "item" + index });
                const checkbox = $("<input>").attr({
                    type: "checkbox",
                    class: "item-checkbox",
                    id: "item" + index,
                    "data-index": index
                });



                // Adicione um identificador aos itens selecionados
                checkbox.attr("data-selecionado", item.selecionado);

                const checkmark = $("<span>").addClass("checkmark");
                checkboxLabel.append(checkbox, checkmark);
                //checkboxContainer.append(checkboxLabel);

                // Formatando os valores como monetários (Reais - BRL)
                const precoFormatado = item.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                const totalItem = (item.quantidade * item.preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                checkboxContainer.append(checkboxLabel, `${item.quantidade} x, ${precoFormatado} ${item.unidade}, ${totalItem}`);
                //const listItem = $("<li>").append(checkboxContainer, `${item.quantidade} x, Preço: ${precoFormatado} ${item.unidade}, Total: ${totalItem}`);
                controlContainer.append(checkboxContainer);
                const listItem = $("<li>").append(controlContainer).addClass("c-control");

                const actionsContainer = $('<div>').addClass('item-options');

                listaUl.append(listItem);

                //button editar
                const editButton = $("<button>").html('<ion-icon name="ios-create"></ion-icon>');
                editButton.click(function () {
                    iniciarEdicaoOuAdicao(index);
                });



                //button excluir
                const deleteButton = $("<button>").addClass('is-danger').html('<ion-icon name="ios-trash"></ion-icon>');
                deleteButton.click(function () {
                    const confirmDelete = confirm("Tem certeza de que deseja excluir este item?");

                    if (confirmDelete) {
                        // O usuário confirmou a exclusão
                        excluirItem(nomeLista, index);
                    }

                   // excluirItem(nomeLista, index); // Chame a função para excluir o item
                });





                actionsContainer.append(deleteButton);
                // listItem.append(editButton);
                actionsContainer.append(editButton);

                listItem.append(actionsContainer);

                // Função para atualizar os totais
                function atualizaTotais(lista) { // Receba a lista como argumento
                    // Recalcule os totais do carrinho e fora do carrinho
                    totalCarrinho = 0;
                    totalForaDoCarrinho = 0;
                    $.each(lista.items, function (index, item) {
                        const totalItem = item.quantidade * item.preco;
                        if (item.selecionado) {
                            totalCarrinho += totalItem;
                        } else {
                            totalForaDoCarrinho += totalItem;
                        }
                    });

                    // Atualize os totais na página
                    const totalCarrinhoFormatado = totalCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const totalForaCarrinhoFormatado = totalForaDoCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    $("#totalCarrinho").text(totalCarrinhoFormatado);
                    $("#totalForaCarrinho").text(totalForaCarrinhoFormatado);

                    // Atualize o LocalStorage com a lista atualizada
                    localStorage.setItem(nomeLista, JSON.stringify(lista));


                }

                // Adicionar eventos para marcar/desmarcar os itens
                checkbox.change(function () {
                    const isChecked = this.checked;
                    const dataIndex = $(this).data("index");

                    // Marcar/desmarcar o item no array de itens
                    lista.items[dataIndex].selecionado = isChecked;

                    // Atualizar o LocalStorage
                    localStorage.setItem(nomeListaAtual.text(), JSON.stringify(lista));

                    // Atualizar o total do carrinho e fora do carrinho
                    atualizaTotais(lista); // Passe a lista como argumento
                });

                // Calculando o total da lista
                totalLista += item.quantidade * item.preco;

                // Verificando se o item já está selecionado e marcando a caixa de seleção, se necessário
                if (item.selecionado) {
                    checkbox.prop("checked", true);
                    totalCarrinho += item.quantidade * item.preco;
                }
            });

            // Exibir totais
            const totalListaFormatado = totalLista.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalCarrinhoFormatado = totalCarrinho.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const totalForaCarrinhoFormatado = (totalLista - totalCarrinho).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            });

            $("#totalLista").text(totalListaFormatado);
            $("#totalCarrinho").text(totalCarrinhoFormatado);
            $("#totalForaCarrinho").text(totalForaCarrinhoFormatado);

            enableSwipeToEdit();
        }

        function abrirModal() {

            buttonAdd.hide();
            setTimeout(function () {
                $(".box-content-modal").addClass("active");

                // location.reload();
                //  $('.full-content.list').removeClass('hidden');
            }, 200); // Tempo de atraso em milissegundos (1 segundo no exemplo)


            // Oculte o botão "btn-add" com a classe "hidden" e remova a classe "show" se estiver presente
            //$(".btn-add").addClass("hidden").removeClass("show");

        }

        function fecharModal() {
            $(".box-content-modal").removeClass("active");

            // Remova a classe "hidden" e adicione a classe "show" para mostrar o botão "btn-add"
            //$(".btn-add").removeClass("hidden").addClass("show");
            buttonAdd.show();
        }


        // Função para aplicar o modo escuro ou claro
        function applyDarkMode(isDarkMode) {
            const body = $('body');

            // Obtenha a cor de fundo atual
            const backgroundColor = body.css('background-color');

            // Atualize a cor da barra de status
            $('meta[name="theme-color"]').attr('content', isDarkMode ? '#333333' : backgroundColor);

            // Atualize a cor do tema
            $('meta[name="apple-mobile-web-app-status-bar-style"]').attr('content', isDarkMode ? 'default' : 'black-translucent');

            // Atualize o ícone do modo claro/escuro
            const darkModeToggle = $('.darkModeToggle');
            if (isDarkMode) {
                darkModeToggle.attr('name', 'sunny');
            } else {
                darkModeToggle.attr('name', 'moon');
            }

            // Aplicar classe dark-mode ao body se o modo escuro estiver ativado
            if (isDarkMode) {
                body.addClass('dark-mode');
            } else {
                body.removeClass('dark-mode');
            }

            // Armazene a preferência do usuário no Local Storage
            localStorage.setItem('darkMode', isDarkMode);
        }


        // Função para alternar o modo claro/escuro
        function toggleDarkMode() {


            const body = $('body');
            const isDarkMode = body.toggleClass('dark-mode').hasClass('dark-mode');
            applyDarkMode(isDarkMode);

            // Atualize o ícone do modo claro/escuro
            const darkModeToggle = $('.darkModeToggle');
            if (isDarkMode) {
                darkModeToggle.attr('name', 'sunny');
            } else {
                darkModeToggle.attr('name', 'moon');
            }

            // Armazene a preferência do usuário no Local Storage
            localStorage.setItem('darkMode', isDarkMode);
        }


        function showList() {
            // Esconde o conteúdo da página definindo o corpo como invisível
            //$('body').css('visibility', 'hidden');
            $('.full-content.list').remove('hidden');


            // Mostra a div de carregamento
            //$('#loading-overlay').css('display', 'flex');

            // Recarrega a página após um breve atraso
            setTimeout(function () {
                // location.reload();
                //  $('.full-content.list').removeClass('hidden');
            }, 1000); // Tempo de atraso em milissegundos (1 segundo no exemplo)

        }
        function hideList() {
            // Esconde o conteúdo da página definindo o corpo como invisível
            //$('body').css('visibility', 'hidden');
            //$('.full-content.home').css('opacity','0.7');
            $('.full-content.list').addClass('hidden');


            // Mostra a div de carregamento
            //$('#loading-overlay').css('display', 'flex');

            // Recarrega a página após um breve atraso
            setTimeout(function () {
                // location.reload();
                //  $('.full-content.list').removeClass('hidden');
            }, 1000); // Tempo de atraso em milissegundos (1 segundo no exemplo)

        }


        function reloadPage() {
            hideList();
            location.reload();
        }




        /* here */
        // Função para exportar itens de uma lista específica
        function exportarItensDaLista(nomeLista) {
            // Obtenha a lista atual do Local Storage
            const lista = JSON.parse(localStorage.getItem(nomeLista));

            if (lista && lista.items && lista.items.length > 0) {
                const dadosParaExportar = {
                    items: lista.items
                };

                // Crie um objeto Blob para o arquivo JSON
                const blob = new Blob([JSON.stringify(dadosParaExportar)], { type: 'application/json' });

                // Crie um URL do Blob
                const url = URL.createObjectURL(blob);

                // Crie um link para o URL do Blob e defina atributos para o download
                const a = document.createElement('a');
                a.href = url;
                a.download = nomeLista + '.json';

                // Clique automaticamente no link para iniciar o download
                a.click();

                // Libere o URL do Blob após o download
                URL.revokeObjectURL(url);
            } else {
                console.error('A lista está vazia ou não existe.');
            }
        }

        // Use JavaScript para lidar com o evento de seleção de arquivo
        document.getElementById('fileInput').addEventListener('change', function (event) {
            var arquivo = event.target.files[0];
            importarItensDoArquivo(arquivo);
        });

        // Função para importar itens de um arquivo JSON e adicionar à lista especificada pelo usuário
        // Função para importar itens de um arquivo JSON e adicionar à lista atual
        function importarItensDoArquivo(arquivo) {
            const leitor = new FileReader();

            leitor.onload = function (e) {
                const itensImportados = JSON.parse(e.target.result);

                if (itensImportados && Array.isArray(itensImportados.items)) {
                    // Obtenha o nome da lista atual do elemento HTML
                    const nomeListaAtual = $("#nomeListaAtual").text().trim();

                    if (nomeListaAtual !== '') {
                        // Obtenha a lista atual do Local Storage ou crie uma nova lista vazia
                        const listaAtual = JSON.parse(localStorage.getItem(nomeListaAtual)) || { items: [] };

                        // Adicione os itens importados à lista atual
                        listaAtual.items = listaAtual.items.concat(itensImportados.items);

                        // Salve a lista atualizada no Local Storage
                        localStorage.setItem(nomeListaAtual, JSON.stringify(listaAtual));

                        // Atualize a interface do usuário ou realize outras ações necessárias
                        console.log('Itens importados com sucesso:', itensImportados.items);

                        // Atualize a lista de listas disponíveis
                        listarListas();
                        mostrarLista(nomeListaAtual);
                    } else {
                        console.error('Nome da lista atual não encontrado.');
                    }
                } else {
                    console.error('Dados de importação inválidos.');
                }
            };

            leitor.readAsText(arquivo);
        }
    </script>


    <script>

        // Carregar a lista de listas quando a página é carregada
        $(document).ready(function () {
            // Inicializar variáveis de controle de deslizamento


            enableSwipeToEdit();
            buttonAdd.hide();

            $('.full-content.list').removeClass('hidden');
            $('#loading-overlay').css('display', 'none');
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                // Se o modo escuro estiver salvo, aplique-o
                applyDarkMode(true);
            }

            listarListas();
            $('.box-content-modal .x-panel-mobile,.close').on('click', function () {
                fecharModal();
            })
            $('.btn-add').on('click', function () {
                iniciarEdicaoOuAdicao();
            })


            const offlineMessage = $("#offline-message");
            const pageContent = $(".full-content");
            console.log('teste', navigator.onLine);
            if (navigator.onLine) {
                offlineMessage.css("display", "none");
            } else {
                offlineMessage.css("display", "block");
                pageContent.css("padding-bottom", "30px");
            }

            //offlineMessage.style.display = navigator.onLine ? "none" : "block";



            /* EXPORTAR / IMPORTAR */

            // Exemplo de como chamar a função de exportação ao clicar em um botão
            $("#botaoExportar").on('click', function () {
                const nomeListaAtual = $("#nomeListaAtual").text();
                exportarItensDaLista(nomeListaAtual);
            });

            $("#dropdownButton").on('click', function () {
                // Toggle a classe "is-active" no menu dropdown usando jQuery
                $("#dropdown-options").toggleClass("is-active");
            });



            /* EXPORTAR / IMPORTAR */

        });


    </script>

    <script>
        /* Verificar status da conexão e exibir mensagem offline ao carregar a página
        document.addEventListener("DOMContentLoaded", () => {
           const offlineMessage = document.getElementById("offline-message");
           console.log(navigator.onLine);
           offlineMessage.style.display = navigator.onLine ? "none" : "block";


       });*/
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/meumercado/service-worker.js')
                .then(function (registration) {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(function (error) {
                    console.log('Erro ao registrar o Service Worker:', error);
                });
        }
    </script>

</body>

</html>